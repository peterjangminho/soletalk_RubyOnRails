<%= turbo_stream_from @session %>

<section class="page-shell" data-session-id="<%= @session.id %>" data-native-bridge="voice">
  <h1>Voice Chat Session #<%= @session.id %></h1>
  <p><%= link_to "Settings", setting_path %></p>

  <%= render "voice_chat/phase_badge",
    phase: (@voice_chat_data&.current_phase || "opener"),
    emotion_level: (@voice_chat_data&.emotion_level || 0.0) %>

  <section class="depth-panel">
    <h2>DEPTH Snapshot</h2>
    <p>Current Phase: <%= @voice_chat_data&.current_phase || "opener" %></p>
    <p>Emotion Level: <%= @voice_chat_data&.emotion_level || 0.0 %></p>
    <meter
      class="emotion-gauge"
      min="0.0"
      max="1.0"
      value="<%= @voice_chat_data&.emotion_level || 0.0 %>">
    </meter>
  </section>

  <section class="native-bridge-panel" data-controller="native-bridge">
    <h2>Native Bridge Controls (Android)</h2>
    <p data-native-bridge-target="status">bridge-unavailable</p>

    <div class="native-bridge-actions">
      <button type="button" data-action="native-bridge#startRecording">Start Recording</button>
      <button type="button" data-action="native-bridge#stopRecording">Stop Recording</button>
    </div>

    <div class="native-bridge-actions">
      <label>
        Transcription
        <input type="text" value="안녕하세요" data-native-bridge-target="transcription">
      </label>
      <button type="button" data-action="native-bridge#sendTranscription">Send Transcription</button>
    </div>

    <div class="native-bridge-actions">
      <label>
        Latitude
        <input type="number" step="0.000001" value="37.5665" data-native-bridge-target="latitude">
      </label>
      <label>
        Longitude
        <input type="number" step="0.000001" value="126.9780" data-native-bridge-target="longitude">
      </label>
      <label>
        Weather
        <input type="text" value="clear" data-native-bridge-target="weather">
      </label>
      <button type="button" data-action="native-bridge#sendLocation">Send Location</button>
      <button type="button" data-action="native-bridge#requestCurrentLocation">Request Current Location</button>
    </div>

    <div class="native-bridge-actions">
      <label>
        TTS
        <input type="text" value="소리를 재생합니다." data-native-bridge-target="tts">
      </label>
      <button type="button" data-action="native-bridge#playAudio">Play Audio</button>
    </div>
  </section>

  <section id="messages">
    <% @session.messages.order(:created_at).each do |message| %>
      <article data-role="<%= message.role %>">
        <p><%= message.content %></p>
      </article>
    <% end %>
  </section>

  <%= form_with model: [@session, Message.new],
    local: true,
    data: { controller: "message-form", action: "turbo:submit-end->message-form#clearAfterSubmit" } do |form| %>
    <%= form.label :content, "Message" %>
    <%= form.text_area :content, data: { message_form_target: "content" } %>
    <%= form.submit "Send" %>
  <% end %>

  <section class="recent-insights-panel">
    <h2>Recent Insights</h2>
    <ul>
      <% @recent_insights.each do |insight| %>
        <li><%= link_to insight.situation, insight_path(insight) %></li>
      <% end %>
    </ul>
  </section>
</section>

<script>
  document.addEventListener("turbo:load", function() {
    if (window.SoleTalkBridge && typeof window.SoleTalkBridge.setSession === "function") {
      window.SoleTalkBridge.setSession("<%= @session.id %>", "<%= current_user.google_sub %>", "<%= @bridge_token %>");
    }
  });
</script>
