<%= turbo_stream_from @session %>

<section class="page-shell session-stage" data-session-id="<%= @session.id %>" data-native-bridge="voice">
  <section
    class="orb-hero orb-hero-session"
    data-controller="particle-orb"
    data-particle-orb-density-value="1.0"
    data-particle-orb-phase-value="<%= @voice_chat_data&.current_phase || "opener" %>"
    data-particle-orb-emotion-value="<%= @voice_chat_data&.emotion_level || 0.0 %>">
    <canvas data-particle-orb-target="canvas" aria-hidden="true"></canvas>
  </section>

  <header class="session-overlay-top">
    <h1><%= t("sessions.show.title", id: @session.id) %></h1>
    <p class="action-row">
      <%= link_to t("sessions.show.actions.back"), sessions_path, class: "btn-link btn-link-secondary" %>
      <%= link_to t("sessions.show.actions.settings"), setting_path, class: "btn-link btn-link-secondary" %>
    </p>

    <%= render "voice_chat/phase_badge",
      phase: (@voice_chat_data&.current_phase || "opener"),
      emotion_level: (@voice_chat_data&.emotion_level || 0.0) %>
  </header>

  <section class="session-overlay-bottom">
    <section id="messages" class="conversation-stack">
      <% @session.messages.order(:created_at).each do |message| %>
        <article data-role="<%= message.role %>">
          <p><%= message.content %></p>
        </article>
      <% end %>
    </section>

    <%= form_with model: [@session, Message.new],
      local: true,
      data: { controller: "message-form", action: "turbo:submit-start->message-form#submitStart turbo:submit-end->message-form#clearAfterSubmit" } do |form| %>
      <%= form.label :content, t("sessions.show.message_form.label") %>
      <%= form.text_area :content, data: { message_form_target: "content" }, placeholder: t("sessions.show.message_form.placeholder") %>
      <%= form.submit t("sessions.show.message_form.submit"), data: { message_form_target: "submit", sending_label: t("sessions.show.message_form.sending"), default_label: t("sessions.show.message_form.submit") } %>
    <% end %>
  </section>

  <section class="session-secondary-panels">
    <section class="depth-panel">
      <h2><%= t("sessions.show.depth_snapshot.title") %></h2>
      <p><%= t("sessions.show.depth_snapshot.current_phase", phase: @voice_chat_data&.current_phase || "opener") %></p>
      <p><%= t("sessions.show.depth_snapshot.emotion_level", level: @voice_chat_data&.emotion_level || 0.0) %></p>
      <meter
        class="emotion-gauge"
        min="0.0"
        max="1.0"
        value="<%= @voice_chat_data&.emotion_level || 0.0 %>">
      </meter>
    </section>

    <section class="recent-insights-panel">
      <h2><%= t("sessions.show.recent_insights.title") %></h2>
      <ul>
        <% @recent_insights.each do |insight| %>
          <li><%= link_to insight.situation, insight_path(insight) %></li>
        <% end %>
      </ul>
    </section>
  </section>

  <details class="native-bridge-debug">
    <summary><%= t("sessions.show.debug.summary") %></summary>
    <section
      class="native-bridge-panel"
      data-controller="native-bridge"
      data-native-bridge-auto-start-value="<%= params[:auto_start_recording] == "1" %>">
      <p class="native-bridge-guide">
        <%= t("sessions.show.debug.guide") %>
      </p>
      <p data-native-bridge-target="status" aria-live="polite">bridge-unavailable</p>

      <div class="native-bridge-actions">
        <button type="button" data-action="native-bridge#startRecording"><%= t("sessions.show.debug.start_recording") %></button>
        <button type="button" data-action="native-bridge#stopRecording"><%= t("sessions.show.debug.stop_recording") %></button>
      </div>

      <div class="native-bridge-actions">
        <label>
          <%= t("sessions.show.debug.transcription_label") %>
          <input type="text" value="<%= t("sessions.show.debug.transcription_sample") %>" data-native-bridge-target="transcription">
        </label>
        <button type="button" data-action="native-bridge#sendTranscription"><%= t("sessions.show.debug.send_transcription") %></button>
      </div>

      <div class="native-bridge-actions">
        <label>
          <%= t("sessions.show.debug.latitude_label") %>
          <input type="number" step="0.000001" value="37.5665" data-native-bridge-target="latitude">
        </label>
        <label>
          <%= t("sessions.show.debug.longitude_label") %>
          <input type="number" step="0.000001" value="126.9780" data-native-bridge-target="longitude">
        </label>
        <label>
          <%= t("sessions.show.debug.weather_label") %>
          <input type="text" value="clear" data-native-bridge-target="weather">
        </label>
        <button type="button" data-action="native-bridge#sendLocation"><%= t("sessions.show.debug.send_location") %></button>
        <button type="button" data-action="native-bridge#requestCurrentLocation"><%= t("sessions.show.debug.request_location") %></button>
      </div>

      <div class="native-bridge-actions">
        <label>
          TTS
          <input type="text" value="<%= t("sessions.show.debug.tts_sample") %>" data-native-bridge-target="tts">
        </label>
        <button type="button" data-action="native-bridge#playAudio"><%= t("sessions.show.debug.play_audio") %></button>
      </div>
    </section>
  </details>
</section>

<script>
  document.addEventListener("turbo:load", function() {
    if (window.SoleTalkBridge && typeof window.SoleTalkBridge.setSession === "function") {
      window.SoleTalkBridge.setSession("<%= @session.id %>", "<%= current_user.google_sub %>", "<%= @bridge_token %>");
    }
  });
</script>
