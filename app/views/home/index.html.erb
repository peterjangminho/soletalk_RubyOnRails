<% content_for :hide_top_nav, "true" %>
<% if current_user %>
  <section class="main-screen"
    data-controller="voice-stage native-bridge quick-upload policy-modal"
    data-native-bridge-auto-permissions-value="true"
    data-quick-upload-url-value="<%= voice_context_files_path %>">
    <div class="main-orb-bg"
      data-controller="particle-sphere"
      data-voice-stage-target="sphere">
      <canvas data-particle-sphere-target="canvas" aria-hidden="true"></canvas>
    </div>

    <header class="main-top-bar">
      <button type="button" class="main-top-icon" aria-label="File Upload"
        data-action="click->quick-upload#openFilePicker">
        <%= render "shared/icon", name: "upload-cloud" %>
      </button>
      <a href="<%= setting_path %>" class="main-top-icon" aria-label="Settings">
        <%= render "shared/icon", name: "cog" %>
      </a>
    </header>

    <input type="file" class="sr-only" data-quick-upload-target="fileInput"
      data-action="change->quick-upload#fileSelected"
      accept=".txt,.pdf,.csv,.json,.md">

    <div class="main-orb-stage">
      <%= form_with url: sessions_path, method: :post, local: true, class: "home-main-mic-form" do |form| %>
        <%= form.hidden_field :entrypoint, value: "main_mic" %>
        <%= render "shared/mic_button", state: "idle" %>
      <% end %>
      <p class="mic-status-text" aria-live="polite"></p>
    </div>

    <div class="upload-bottom-sheet" data-quick-upload-target="sheet" hidden>
      <div class="upload-sheet-content">
        <p class="upload-sheet-title"><%= t("home.upload.confirm_title", default: "Add to conversation?") %></p>
        <p class="upload-sheet-file" data-quick-upload-target="fileInfo"></p>
        <div class="upload-sheet-actions">
          <button type="button" class="btn-link" data-action="click->quick-upload#confirm">
            <%= t("home.upload.confirm", default: "Add File") %>
          </button>
          <button type="button" class="btn-link btn-link-secondary" data-action="click->quick-upload#cancel">
            <%= t("home.upload.cancel", default: "Cancel") %>
          </button>
        </div>
      </div>
    </div>

    <p class="bridge-fallback" data-voice-stage-target="bridgeFallback" hidden></p>

    <%= render "shared/policy_modal" %>
  </section>
<% else %>
  <section class="login-screen">
    <section
      class="home-opening-overlay"
      data-controller="opening-animation"
      data-opening-animation-target="overlay"
      aria-hidden="true">
      <canvas class="home-opening-canvas" data-opening-animation-target="canvas"></canvas>
      <div class="home-opening-logo">SoleTalk</div>
      <button
        class="home-opening-skip"
        data-action="opening-animation#skip"
        aria-label="Skip animation">
        Skip
      </button>
    </section>

    <h1 class="login-brand">Sole<span>Talk</span></h1>
    <div class="login-brand-divider"></div>
    <p class="login-tagline"><%= t("home.subtitle") %></p>

    <div class="login-card" id="sign-in" data-controller="consent-gate">
      <h2><%= t("home.sign_in.title") %></h2>
      <p><%= t("home.sign_in.description") %></p>

      <label class="consent-checkbox">
        <input type="checkbox"
          data-consent-gate-target="checkbox"
          data-action="change->consent-gate#toggle">
        <%= t("home.sign_in.consent_label") %>
      </label>

      <p class="action-row">
        <%= link_to "/auth/google_oauth2/start?consent_accepted=1",
              class: "btn-link btn-link-disabled btn-google",
              data: { turbo: false, consent_gate_target: "gated" },
              aria: { disabled: true } do %>
          <%= render "shared/google_icon" %>
          <%= t("home.sign_in.cta") %>
        <% end %>
      </p>

      <div class="login-divider"><span>or</span></div>

      <p class="action-row">
        <%= form_with url: guest_sign_in_path, method: :post, local: true, class: "inline-auth-action" do |form| %>
          <%= form.hidden_field :consent_accepted, value: "1" %>
          <%= form.submit t("home.sign_in.guest_cta"),
                class: "btn-link btn-link-secondary btn-link-disabled",
                disabled: true,
                data: { consent_gate_target: "gated" } %>
        <% end %>
      </p>

      <% if Rails.env.development? || Rails.env.test? %>
        <p class="action-row">
          <%= form_with url: dev_sign_in_path, method: :post, local: true, class: "dev-sign-in-form" do |form| %>
            <%= form.hidden_field :google_sub, value: "dev-mobile-user" %>
            <%= form.submit t("home.sign_in.dev_cta"),
                  class: "btn-link btn-link-secondary btn-link-disabled",
                  disabled: true,
                  data: { consent_gate_target: "gated" } %>
          <% end %>
        </p>
      <% end %>
    </div>

    <div class="login-lang-toggle">
      <% if I18n.locale == :ko %>
        <a href="/?locale=en" class="lang-option" data-turbo="false">English</a>
        <span class="lang-option lang-active">한국어</span>
      <% else %>
        <span class="lang-option lang-active">English</span>
        <a href="/?locale=ko" class="lang-option" data-turbo="false">한국어</a>
      <% end %>
    </div>
  </section>
<% end %>
